{% extends "seaver_app/starter.html" %}
{% load static %}

{% block title %}
Seaver | Dashboard
{% endblock %}

{% block header_title %}
{{ wname }}
{% endblock %}
{% block header_desc %}
Control Panel
{% endblock %}



{% block contentplusbutton %}
{% endblock %}

{% block sidebarmenu %}
    <li class="treeview active">
        <a href="#">
            <i class="fa fa-dashboard"></i> <span>Files</span>
            <div class="box-tools pull-right">
                <button class="btn btn-primary btn-sm" data-toggle="modal"
                        data-target="#create_file_modal"><i class="fa fa-plus"></i></button>
            </div>
        </a>
        <ul id="files_list" class="treeview-menu">
            <li v-for="(f, index) in files" class="active"><a href="#"><i class="fa fa-circle-o"></i>
                [[ f.name ]]
                <i class="fa fa-times pull-right"
                   v-on:click="ask_delete_file_confirm(index)"></i></a></li>
        </ul>
    </li>
    <li class="treeview">
        <a href="#">
            <i class="fa fa-dashboard"></i><span>Annotation type</span>
            <div class="box-tools pull-right">
                <button class="btn btn-primary btn-sm" data-toggle="modal"
                        data-target="#create_annotation_type_modal"><i class="fa fa-plus"></i></button>
            </div>
        </a>
        <ul id="annotation_type" class="treeview-menu" style="display: none;">
            <li v-for="(anns, ann_type, index) in anns" class="">
                <a href="#"><i class="fa fa-circle-o"></i>
                    <span> [[ ann_type ]] </span>
                    <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i>
            </span>
                </a>
                <ul class="treeview-menu" style="display: none;">
                    <li v-for="(a, index) in anns" class="active"><a href="#"><i class="fa fa-circle-o"></i>
                        [[ a.name ]]
                        <i class="fa fa-times pull-right"
                             v-on:click="ask_delete_annotation_type_confirm(ann_type, index)"></i></a></li>
                </ul>
            </li>
        </ul>
    </li>
    <li class="header">DATA ON CHART</li>
    <li class="treeview">
        <a href="#">
            <i class="fa fa-dashboard"></i> <span>Punctual annotations</span>
            <div class="box-tools pull-right">
            </div>
        </a>
        <ul id="p_events_list" class="treeview-menu">
            <li v-for="(e, index) in events" class="active" v-on:mouseover="highlight_event(index)"
                v-on:mouseout="remove_highlight_event(index)"><a href="#"><i class="fa fa-circle-o"></i>
                [[ e.annotation.name ]]
                <i class="fa fa-times pull-right"
                   v-on:click="ask_delete_punctual_confirm(index)"></i></a></li>
        </ul>
    </li>
    <li class="treeview">
        <a href="#">
            <i class="fa fa-dashboard"></i> <span>Interval annotations</span>
            <div class="box-tools pull-right">
            </div>
        </a>
        <ul id="i_events_list" class="treeview-menu">
            <li v-for="(e, index) in events" class="active" v-on:mouseover="highlight_event(index)"
                v-on:mouseout="remove_highlight_event(index)"><a href="#"><i class="fa fa-circle-o"></i>
                [[ e.annotation.name ]]
                <i class="fa fa-times pull-right"
                   v-on:click="ask_delete_confirm(index)"></i></a></li>
        </ul>
    </li>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Plot</h3>
                    <div class="box-tools pull-right">
                        <button class="btn btn-primary btn-sm" data-toggle="modal"
                                data-target="#export_file_modal"><i class="fa fa-download" aria-hidden="true"
                                                                    style="font-size: 2.0em;"></i></button>
                    </div>
                </div>

                <div class="box-body">
                    <div class="chart">
                        <div id="chartdiv" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">File properties control panel</h3>
                </div>
                <div class="box-body">
                    <div id="file_properties_form">
                        <strong>Offset</strong>
                        <input class="form-control" v-model.number="offset">
                        <strong>Stretching</strong>
                        <input class="form-control" v-model.number="stretching">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div id="points_per_field" class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Points per field</h3>
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                    <strong>Number of points</strong>
                    <input class="form-control" v-model.number="n_points">
                </div>
                <!-- /.box-body -->
            </div>
        </div>
    </div>


    <!-- LOADING FILE MODAL -->
    <div class="modal fade" id="loading_file_modal" tabindex="-1" role="dialog"
         aria-labelledby="loading_file_modal_label">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="loading_file_modal_label">Loading files ...</h4>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
                             aria-valuemax="100" style="width: 0%">
                            0%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create file modal -->
    <div class="modal fade" id="create_file_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">{{ wname }} - Upload new file</h4>
                </div>
                <div class="modal-body">
                    <form role="form" enctype="multipart/form-data" id="create_file_form" action="{{ form_action }}"
                          method="post" onsubmit="return false">
                        <div id="create_file_form_errors"></div>
                        {% csrf_token %}
                        {{ file_upload_form }}
                        <div id="spinner"
                             style="width: 100%; height: 100%; background-color: rgba(0,0,0,.5); -webkit-transition: all .5s ease; z-index: 1000;"></div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary" id="upload_file_button">Upload</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Create annotation type modal -->
    <div class="modal fade" id="create_annotation_type_modal" tabindex="-1" role="dialog"
         aria-labelledby="create_annotation_type_modal_label">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="create_annotation_type_modal_label">Create new annotation type</h4>
                </div>
                <div class="modal-body">
                    <form role="form" id="create_annotation_type_form" method="post" onsubmit="return false">
                        <div id="create_annotation_type_form_errors"></div>

                        <div>
                            <fieldset class="module aligned ">
                                <p><label class="required" for="select_ann_type">Annotation type:</label></p>
                                <select class="form-control" id="select_ann_type">
                                    <option>Punctual</option>
                                    <option>Interval</option>
                                </select>
                                <br>
                                <div class="form-row field-name">
                                    <div>
                                        <p><label class="required" for="ann_type_name">Name:</label></p>
                                        <input type="text" name="name" maxlength="20" id="ann_type_name" required
                                               class="vTextField"/>
                                    </div>
                                </div>
                                <br>
                                <div class="form-row field-description">
                                    <div>
                                        <p><label class="required" for="ann_type_description">Description:</label></p>
                                        <textarea name="description" id="ann_type_description" required cols="78"
                                                  class="vLargeTextField" rows="3">
                                        </textarea>
                                    </div>
                                </div>
                            </fieldset>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary" id="create_annotation_type_button">Create
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete file modal -->
    <div class="modal fade" id="delete_file_modal" tabindex="-1" role="dialog"
         aria-labelledby="delete_file_modal_label">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="delete_file_modal_label">Delete file</h4>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the file ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
                    <button type="button" class="btn btn-primary" id="confirm_delete_file">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete annotation type modal -->
    <div class="modal fade" id="delete_annotation_type_modal" tabindex="-1" role="dialog"
         aria-labelledby="delete_annotation_type_modal_label">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="delete_annotation_type_modal_label">Delete annotation type</h4>
                </div>
                <div class="modal-body">
                    <h4>Are you sure you want to delete the annotation type ?</h4>
                    <h8 style="color: red;"><strong>All the annotations' events of this type will be removed!</strong>
                    </h8>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
                    <button type="button" class="btn btn-primary" id="confirm_delete_annotation_type">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export file modal -->
    <div class="modal fade" id="export_file_modal" tabindex="-1" role="dialog"
         aria-labelledby="export_file_modal_label">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="export_file_modal_label">Export workspace</h4>
                </div>
                <div class="modal-body">
                    Do you want to export the current workspace ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
                    <a href="{% url 'workspace_export' workspace.name %}" download target="_blank"
                       id="export_confirm_button">
                        <button type="button" class="btn btn-primary">Yes</button>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Data processing modal -->
    <div class="modal fade" id="data_processing_modal" tabindex="-1" role="dialog"
         aria-labelledby="data_processing_modal_label">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="data_processing_modal_label">Data processing ...</h4>
                </div>
                <div class="modal-body">
                    <center>
                        <img src="{% static "seaver_app/imgs/light_blue_material_design_loading.gif" %}">
                        <h4>Please wait, we are processing data...</h4>
                    </center>

                </div>
            </div>
        </div>
    </div>

    <!-- Delete punctual event modal -->
    <div class="modal fade" id="delete_punctual_event_modal" tabindex="-1" role="dialog"
         aria-labelledby="delete_punctual_event_modal_label">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="delete_punctual_event_modal_label">Delete Event</h4>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the event ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
                    <button type="button" class="btn btn-primary" id="confirm_delete_punctual_event">Yes</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Delete interval event modal -->
    <div class="modal fade" id="delete_interval_event_modal" tabindex="-1" role="dialog"
         aria-labelledby="delete_interval_event_modal_label">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="delete_interval_event_modal_label">Delete Event</h4>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the event ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
                    <button type="button" class="btn btn-primary" id="confirm_delete_interval_event">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete analysis modal -->
    <div class="modal fade" id="delete_analysis_modal" tabindex="-1" role="dialog"
         aria-labelledby="delete_analysis_modal_label">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="delete_analysis_modal_label">Delete Analysis</h4>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the analysis ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
                    <button type="button" class="btn btn-primary" id="confirm_delete_analysis">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Show punctual annotations -->
    <div class="modal fade" id="show_punctual_annotations_modal" tabindex="-1" role="dialog"
         aria-labelledby="show_punctual_annotations_modal_label">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="show_punctual_annotations_modal_label">Select punctual annotation</h4>
                </div>
                <div class="pre-scrollable">
                    <div id="select_puntual_annotation_menu" class="modal-body">
                        <div class="box"
                             v-for="(a, index) in annotations">
                            <div style="cursor: pointer;" v-on:click="create_event(index)"
                                 onmouseover="this.style.background='#f4f4f4';"
                                 onmouseout="this.style.background='white';">
                                <div class="box-header with-border">
                                    <h3 class="box-title">[[ a.name ]]</h3>
                                    <div class="box-tools pull-right">
                                    </div>
                                </div>

                                <div class="box-body">
                                    [[ a.description ]]
                                </div>
                            </div>
                        </div>
                        <div class="box-footer clearfix no-border">
                            <button class="btn btn-default pull-right" onclick="add_punctual_type_ann()"><i
                                    class="fa fa-plus"></i> Add annotation type
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Show interval annotations -->
    <div class="modal fade" id="show_interval_annotations_modal" tabindex="-1" role="dialog"
         aria-labelledby="show_interval_annotations_modal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="delete_event_modal_label">Select interval annotation</h4>
                </div>
                <div class="pre-scrollable">
                    <div id="select_interval_annotation_menu" class="modal-body">
                        <div class="box"
                             v-for="(a, index) in annotations">
                            <div style="cursor: pointer;" v-on:click="create_event(index)"
                                 onmouseover="this.style.background='#f4f4f4';"
                                 onmouseout="this.style.background='white';">
                                <div class="box-header with-border">
                                    <h3 class="box-title">[[ a.name ]]</h3>
                                    <div class="box-tools pull-right">
                                    </div>
                                </div>
                                <div class="box-body">
                                    [[ a.description ]]
                                </div>
                            </div>
                        </div>
                        <div class="box-footer clearfix no-border">
                            <button class="btn btn-default pull-right" onclick="add_interval_type_ann()"><i
                                    class="fa fa-plus"></i> Add annotation type
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- creazione di un'analisi -->
    <div class="modal fade" id="create_analysis_modal" tabindex="-1" role="dialog"
         aria-labelledby="create_analysis_modal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="create_analysis_modal_label">Analysis creation</h4>
                </div>
                <div class="modal-body">
                    <div class="pre-scrollable">
                        <div id="analysis_options_menu">
                            <ul>
                                <strong><p v-for="e in errors.options.ewma.non_field_errors" style="color:red;">
                                    [[ e ]]
                                </p></strong>
                            </ul>
                            <div>Name</div>
                            <input type="text" class="form-control" v-model="name"
                                   placeholder="Insert a name for the analysis">
                            <ul>
                                <strong><p v-for="e in errors.name" style="color:red;">
                                    [[ e ]]
                                </p></strong>
                            </ul>
                            <div>Type</div>
                            <select class="form-control" v-model="type">
                                <option disabled value="">Please select a type</option>
                                <option v-for="t in analysis_types">[[ t ]]</option>
                            </select>
                            <ul>
                                <strong><p v-for="e in errors.type" style="color:red;">
                                    [[ e ]]
                                </p></strong>
                            </ul>
                            <div v-show="show_fft">
                                <div>Number of points</div>
                                <input class="form-control" v-model.number="options['fft'].n">
                                <ul>
                                    <strong><p v-for="e in errors.options.fft.n" style="color:red;">
                                        [[ e ]]
                                    </p></strong>
                                </ul>
                                <div>Normalization mode</div>
                                <select class="form-control" v-model="options['fft'].norm">
                                    <option selected>None</option>
                                    <option>ortho</option>
                                </select>
                                <ul>
                                    <strong><p v-for="e in errors.options.fft.norm" style="color:red;">
                                        [[ e ]]
                                    </p></strong>
                                </ul>
                                <ul>
                                    <strong><p v-for="e in errors.options.fft.non_field_errors" style="color:red;">
                                        [[ e ]]
                                    </p></strong>
                                </ul>
                            </div>
                            <div v-show="show_ewma">
                                <div>Center of mass (COM)</div>
                                <input class="form-control" v-model.number="options['ewma'].com">
                                <ul>
                                    <strong><p v-for="e in errors.options.ewma.com" style="color:red;">
                                        [[ e ]]
                                    </p></strong>
                                </ul>
                                <div>Decay (in span)</div>
                                <input class="form-control" v-model.number="options['ewma'].span">
                                <ul>
                                    <strong><p v-for="e in errors.options.ewma.span" style="color:red;">
                                        [[ e ]]
                                    </p></strong>
                                </ul>
                                <div>Decay (in halflife)</div>
                                <input class="form-control" v-model.number="options['ewma'].halflife">
                                <ul>
                                    <strong><p v-for="e in errors.options.ewma.halflife" style="color:red;">
                                        [[ e ]]
                                    </p></strong>
                                </ul>
                                <div>Minimum number of observations</div>
                                <input class="form-control" v-model.number="options['ewma'].min_periods">
                                <ul>
                                    <strong><p v-for="e in errors.options.ewma.min_periods" style="color:red;">
                                        [[ e ]]
                                    </p></strong>
                                </ul>
                                <div>Frequency</div>
                                <input class="form-control" v-model="options['ewma'].freq">
                                <ul>
                                    <strong><p v-for="e in errors.options.ewma.freq" style="color:red;">
                                        [[ e ]]
                                    </p></strong>
                                </ul>
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" v-model="options['ewma'].adjust">
                                        Decaying adjustment factor
                                    </label>
                                </div>
                                <ul>
                                    <strong><p v-for="e in errors.options.ewma.adjust" style="color:red;">
                                        [[ e ]]
                                    </p></strong>
                                </ul>
                                <div>Method for down- or re-sampling</div>
                                <input class="form-control" v-model="options['ewma'].how">
                                <ul>
                                    <strong><p v-for="e in errors.options.ewma.how" style="color:red;">
                                        [[ e ]]
                                    </p></strong>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="create_analysis"
                            v-on:click="create_analysis()">
                        Create
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block right_sidebar %}
    <div class="tab-content">
        <!-- Home tab content -->
        <div class="tab-pane active" id="control-sidebar-home-tab">
            <div>
                <h5 class="control-sidebar-heading">Select files or fields ...</h5>
                <ul id="menu_files_list" class="list-unstyled">
                    <li v-for="(f, f_index) in files" class="active">
                        <i
                                v-on:click="select_file(f_index)"
                                v-bind:class="(f_index === file_selected_index) ? 'fa fa-dot-circle-o' : 'fa fa-circle-o'"
                                style="cursor:pointer"
                        ></i>
                        <span v-on:click="select_file(f_index)" style="cursor:pointer">[[ f.name ]]</span><i
                            v-bind:class="f.active ? 'fa fa-check-square-o pull-right' : 'fa fa-square-o pull-right'"
                            v-on:click="activate_file(f_index)"
                            style="cursor:pointer"></i>
                        <ul v-for="(ff, ff_index) in f.fields">
                            <li>
                            <span
                                    v-show="ff.name_on_change ? false : true"
                                    v-on:click="show_change_name_box(f_index, ff_index)"
                                    style="cursor:pointer">[[ ff.name ]]</span>
                                <input class="form-control input-sm" type="text" v-model="ff.name"
                                       v-show="ff.name_on_change ? true : false"
                                       v-on:keyup.enter="change_name(f_index, ff_index)">
                                <i
                                        v-bind:class="ff.active ? 'fa fa-check-square-o pull-right' : 'fa fa-square-o pull-right'"
                                        v-on:click="activate_field(f_index, ff_index)"
                                        style="cursor:pointer"></i>
                                <i class="fa fa-plus-square pull-right"
                                   v-on:click="select_analysis(f_index, ff_index)"
                                   style="cursor:pointer"></i>
                                <i class="fa fa-remove pull-right" v-if="ff.computed"
                                   v-on:click="ask_delete_field(f_index, ff_index)"
                                   style="cursor:pointer"></i>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
{% endblock %}

{% block append %}
    <!-- AMCHARTS -->
    <script src="{% static 'seaver_app/amcharts/amcharts.js' %}"></script>
    <script src="{% static 'seaver_app/amcharts/serial.js' %}"></script>

    <script src="{% static "seaver_app/js/workspace/workspace.js" %}"></script>

    <script src="{% static 'seaver_app/js/chart_manager.js' %}"></script>
    <script src="{% static 'seaver_app/js/request_watcher.js' %}"></script>
    <script src="{% static 'seaver_app/js/workspace/data_download.js' %}"></script>
    <script src="{% static 'seaver_app/js/workspace/request_watcher.js' %}"></script>

    <script>

        function add_punctual_type_ann() {
            $("#show_punctual_annotations_modal").modal('toggle');
            $("#create_annotation_type_modal").modal('toggle');
        }

        function add_interval_type_ann() {
            $("#create_annotation_type_modal").modal('toggle');
            $("#show_interval_annotations_modal").modal('toggle');
        }

        // gestisce il bug che si verifica quando due modal vengono aperti successivamente
        // elimina il padding sbagliato del body
        $("body").on("transitionend", function () {
            $("body").css("padding-right", "0px");
        });

        window.onload = function () {

            workspace_url = '{% url 'workspace-detail' workspace.pk %}';
            punctual_url = '{% url "punctualannotation-list" %}';
            interval_url = '{% url "intervalannotation-list" %}';

            // CREO GLI ELEMENTI VUE

            $('#confirm_delete_file').on("click", function () {
                delete_file();
            });

            //gestisce la barra laterale dei file
            v_files = new Vue({
                el: '#files_list',
                data: {
                    files: [],
                    index_to_delete: -1
                },
                methods: {
                    ask_delete_file_confirm: function (index) {
                        $('#delete_file_modal').modal('toggle');
                        this.index_to_delete = index;
                    }
                }
            });

            $('#confirm_delete_analysis').on("click", function () {
                menu_files.delete_field();
            });

            menu_files = new Vue({
                el: '#menu_files_list',
                data: {
                    files: [],
                    file_selected_index: -1,
                    select_analysis_file_index: undefined,
                    select_analysis_field_index: undefined,
                    f_index_to_delete: -1,
                    ff_index_to_delete: -1
                },
                computed: {
                    selected_file_offset: {
                        get: function () {
                            // se nessun file è stato selezionato
                            if (this.file_selected_index < 0)
                                return 0;

                            return this.files[this.file_selected_index].offset;
                        },
                        set: function (value) {
                            // se nessun file è stato selezionato esco
                            if (this.file_selected_index < 0)
                                return;

                            // controllo che sia un numero
                            if (typeof value !== "number")
                                return;

                            // controllo che il valore non sia minore di 0
                            if (value < 0)
                                return;

                            // trasformo in int se necessario
                            value = Math.round(value);

                            this.files[this.file_selected_index].offset = value;

                            // mando i risultati al server
                            this.send_file_properties_to_server();
                        }
                    },
                    selected_file_stretching: {
                        get: function () {
                            // se nessun file è stato selezionato
                            if (this.file_selected_index < 0)
                                return 1;

                            return this.files[this.file_selected_index].stretching;
                        },
                        set: function (value) {
                            // se nessun file è stato selezionato esco
                            if (this.file_selected_index < 0)
                                return;

                            // controllo che sia un numero
                            if (typeof value !== "number")
                                return;

                            // controllo che il valore non sia minore di 1
                            if (value < 1)
                                return;

                            // trasformo in int se necessario
                            value = Math.round(value);

                            this.files[this.file_selected_index].stretching = value;

                            // mando i risultati al server
                            this.send_file_properties_to_server();
                        }
                    }
                },
                methods: {
                    activate_file: function (index) {
                        {# attivo/disattivo il file e salvo il risultato su server  #}
                        var f = this.files[index];
                        f.active = !f.active;
                        $.ajax(f.url, {
                            method: "PATCH",
                            data: {
                                "active": f.active
                            }
                        });

                        // attivo / disattivo i file
                        chart_manager.show_hide_file(f);
                    },
                    activate_field: function (file_index, field_index) {
                        var f = this.files[file_index];
                        var field = f.fields[field_index];

                        // cambio il valore di active e lo salvo nel db
                        field.active = !field.active;
                        $.ajax(field.url, {
                            method: "PATCH",
                            data: {
                                "active": field.active
                            }
                        });

                        // visualizzo / nascondo il campo
                        var chart_field_name = chart_manager.get_field_name(f, field);
                        if (f.active && field.active)
                            chart_manager.show_graph(chart_field_name);
                        else
                            chart_manager.hide_graph(chart_field_name);
                    },
                    show_change_name_box: function (f_index, ff_index) {
                        // mostra il box dove è possibile cambiare il nome del campo

                        var field = this.files[f_index].fields[ff_index];

                        // creo una copia deep
                        field.previous_name = field.name.substr(0);

                        field.name_on_change = true;
                    },
                    change_name: function (f_index, ff_index) {
                        // prova ad aggiornare il nome del campo
                        var f = this.files[f_index];
                        var field = f.fields[ff_index];

                        // salvo il risultato nel db
                        $.ajax(field.url, {
                            method: 'PATCH',
                            data: {
                                'name': field.name
                            }
                        }).done(function () {
                            // cambio il nome nel grafico
                            var previous_graph_name = f.name + '_' + field.previous_name;
                            var current_graph_name = chart_manager.get_field_name(f, field);

                            chart_manager.rename_field(previous_graph_name, current_graph_name);
                            chart_manager.refresh();
                        }).fail(function () {
                            // rimetto il nome precedente
                            field.name = field.previous_name;
                        }).always(function () {
                            field.name_on_change = false;
                        })
                    },
                    select_file: function (f_index) {
                        // funzione che si attiva quando selezioni il file

                        // salvo gli indici del campo selezionato
                        this.file_selected_index = f_index;
                    },
                    send_file_properties_to_server: _.debounce(function () {
                            // mando il nuovo offset e stretching al server

                            // se nessun file è stato selezionato allora esco
                            if (this.file_selected_index < 0)
                                return;

                            // recupero il file selezionato
                            var f = this.files[this.file_selected_index];

                            // salvo le nuove proprietà sul server
                            $.ajax(f.url, {
                                method: 'PATCH',
                                data: {
                                    'offset': f.offset,
                                    'stretching': f.stretching
                                }
                            }).done(function () {
                                // aggiorno il grafico
                                // chart_manager.delete_file(f);
                                // chart_manager.add_file(f);
                                for (var i = 0; i < f.fields.length; i += 1) {
                                    var chart_field_name = chart_manager.get_field_name(f, f.fields[i]);
                                    chart_manager.set_offset(chart_field_name, f.offset);
                                    chart_manager.set_stretching(chart_field_name, f.stretching);
                                }
                                chart_manager.refresh();
                            })
                        },
                        // esegui l'operazione ogni tot secondi
                        1500),
                    select_analysis: function (f_index, ff_index) {
                        // apre la finestra di creazione di un'analisi per il field specificato

                        // memorizzo il field selezionato
                        this.select_analysis_file_index = f_index;
                        this.select_analysis_field_index = ff_index;

                        // cancello gli errori d'analisi
                        analysis_options_menu.reset_errors();
                        // apro la finestra di selezione dell'analisi
                        $('#create_analysis_modal').modal('toggle');
                    },
                    ask_delete_field: function (f_index, ff_index) {
                        $('#delete_analysis_modal').modal('toggle');
                        this.f_index_to_delete = f_index;
                        this.ff_index_to_delete = ff_index;
                    },
                    delete_field: function () {
                        var f_index = this.f_index_to_delete;
                        var ff_index = this.ff_index_to_delete;
                        var file = this.files[f_index];
                        var field = file.fields[ff_index];

                        $.ajax(field.url, {
                            method: 'DELETE'
                        }).done(function () {
                            // cancello il campo dal grafico
                            var chart_field_name = chart_manager.get_field_name(file, field);
                            chart_manager.delete_field(chart_field_name);
                            chart_manager.refresh();

                            // cancello il campo dal menù
                            file.fields.splice(ff_index, 1);

                            // chiudo la finestra
                            $('#delete_analysis_modal').modal('toggle');
                        }).fail(function (data) {
                            console.log(data);
                        })
                    }
                }
            });

            // collegato alla form per modificare offset e stretching del file
            file_propery_form = new Vue({
                el: '#file_properties_form',
                computed: {
                    offset: {
                        get: function () {
                            return menu_files.selected_file_offset;
                        },
                        set: function (value) {
                            menu_files.selected_file_offset = value;
                        }
                    },
                    stretching: {
                        get: function () {
                            return menu_files.selected_file_stretching;
                        },
                        set: function (value) {
                            menu_files.selected_file_stretching = value;
                        }
                    }
                }
            });

            points_per_field = new Vue({
                el: '#points_per_field',
                data: {
                    'previous_n_points': 50
                },
                computed: {
                    'n_points': {
                        get: function () {
                            return this.previous_n_points;
                        },
                        set: function (value) {
                            // controllo che sia un numero
                            if (typeof value !== "number")
                                return;

                            // controllo che il valore non sia minore di 0
                            if (value < 0)
                                return;

                            this.previous_n_points = value;

                            this.refresh_n_points();
                        }
                    }
                },
                methods: {
                    'refresh_n_points': _.debounce(function () {
                            chart_manager.set_points_per_field(points_per_field.n_points);
                            chart_manager.refresh();
                        },
                        500)
                }
            });

            $('#confirm_delete_punctual_event').on("click", function () {
                menu_punctual_events.delete_event()
            });

            menu_punctual_events = new Vue({
                el: "#p_events_list",
                data: {
                    events: [],
                    default_color_event: '#CC0000',
                    highlight_color_event: '#00cc03',
                    index_to_delete: -1
                },
                methods: {
                    ask_delete_punctual_confirm: function (index) {
                        this.index_to_delete = index;
                        $('#delete_punctual_event_modal').modal('toggle');

                    },
                    delete_event: function () {
                        var index = menu_punctual_events.index_to_delete;

                        // esco dalla finestra di cancellazione
                        $('#delete_punctual_event_modal').modal('toggle');

                        // cancello l'evento nel server
                        var e = this.events[index];
                        $.ajax(e.url, {
                            method: 'DELETE'
                        }).done(function () {
                            // cancello l'evento dalla lista
                            menu_punctual_events.events.splice(index, 1);

                            // cancello l'evento dal grafico
                            chart_manager.remove_event(e);
                            chart_manager.refresh_properties();
                        })
                    },
                    delete_events_by_name: function (event_name) {
                        remaining_events = [];
                        events_to_delete = [];
                        for (var i = 0; i < this.events.length; i++) {
                            var event = this.events[i];
                            if (event.annotation.name == event_name)
                                events_to_delete.push(event);
                            else
                                remaining_events.push(event);
                        }
                        this.events = remaining_events;

                        for (var i = 0; i < events_to_delete.length; i++) {
                            var ev = events_to_delete[i];
                            // cancello l'evento dal grafico
                            chart_manager.remove_event(ev);
                            chart_manager.refresh_properties();
                        }

                    },
                    highlight_event: function (index) {
                        chart_manager.color_event(this.events[index], this.highlight_color_event);
                        chart_manager.refresh_properties();
                    },
                    remove_highlight_event: function (index) {
                        chart_manager.color_event(this.events[index], this.default_color_event);
                        chart_manager.refresh_properties();
                    }
                }
            });

            $('#delete_interval_event_modal').on("click", function () {
                menu_interval_events.delete_event()
            });

            menu_interval_events = new Vue({
                el: "#i_events_list",
                data: {
                    events: [],
                    default_color_event: '#CC0000',
                    highlight_color_event: '#00cc03',
                    index_to_delete: -1
                },
                methods: {
                    ask_delete_confirm: function (index) {
                        this.index_to_delete = index;
                        $('#delete_interval_event_modal').modal('toggle');
                    },
                    delete_event: function () {
                        var index = menu_interval_events.index_to_delete;

                        // cancello l'evento nel server
                        var e = this.events[index];
                        $.ajax(e.url, {
                            method: 'DELETE'
                        }).done(function () {
                            // cancello l'evento dalla lista
                            menu_interval_events.events.splice(index, 1);

                            // cancello l'evento dal grafico
                            chart_manager.remove_event(e);
                            chart_manager.refresh_properties();

                            // esco dalla finestra di cancellazione
                            $('#delete_interval_event_modal').modal('toggle');

                        })
                    },
                    delete_events_by_name: function (event_name) {
                        remaining_events = [];
                        events_to_delete = [];
                        for (var i = 0; i < this.events.length; i++) {
                            var event = this.events[i];
                            if (event.annotation.name === event_name)
                                events_to_delete.push(event);
                            else
                                remaining_events.push(event);
                        }
                        this.events = remaining_events;

                        for (i = 0; i < events_to_delete.length; i++) {
                            var ev = events_to_delete[i];
                            // cancello l'evento dal grafico
                            chart_manager.remove_event(ev);
                            chart_manager.refresh_properties();
                        }
                    },
                    highlight_event: function (index) {
                        chart_manager.color_event(this.events[index], this.highlight_color_event);
                        chart_manager.refresh_properties();
                    },
                    remove_highlight_event: function (index) {
                        chart_manager.color_event(this.events[index], this.default_color_event);
                        chart_manager.refresh_properties();
                    }
                }
            });

            $('#confirm_delete_annotation_type').on("click", function () {
                annotation_type.delete_annotation_type();
            });

            annotation_type = new Vue({
                el: '#annotation_type',
                data: {
                    anns: annotation_events,
                    ann_type_to_delete: "",
                    index_to_delete: -1
                },
                methods: {
                    ask_delete_annotation_type_confirm: function (ann_type, index) {
                        this.ann_type_to_delete = ann_type;
                        this.index_to_delete = index;
                        $('#delete_annotation_type_modal').modal('toggle');
                    },
                    delete_annotation_type: function () {
                        var ann_type = annotation_type.ann_type_to_delete;
                        var index = annotation_type.index_to_delete;
                        // esco dalla finestra di cancellazione
                        $('#delete_annotation_type_modal').modal('toggle');
                        // cancello l'evento nel server
                        var e = this.anns[ann_type][index];

                        $.ajax(e.url, {
                            method: 'DELETE'
                        }).done(function () {
                            // cancello l'evento dalla lista
                            annotation_type.anns[ann_type].splice(index, 1);

                            var menu_events;
                            if (ann_type === "punctual")
                                menu_events = menu_punctual_events;
                            else
                                menu_events = menu_interval_events;

                            menu_events.delete_events_by_name(e.name);

                            // cancello l'evento dal grafico
                            //chart_manager.remove_event(e);
                            //chart_manager.refresh_properties();
                        })
                    }
                }
            });

            select_puntual_annotation_menu = new Vue({
                el: '#select_puntual_annotation_menu',
                data: {
                    annotations: annotation_events.punctual,
                    start: undefined,
                    punctual_event_url: '{% url "punctualannotationevent-list" %}'
                },
                methods: {
                    create_event: function (annotation_index) {
                        var annotation = this.annotations[annotation_index];
                        $.ajax(this.punctual_event_url, {
                            'method': 'POST',
                            'data': {
                                'workspace': workspace.url,
                                'annotation': annotation.url,
                                'start': this.start
                            }
                        }).done(function (res) {
                            // ottengo l'annotazione corrispondente
                            res.annotation = annotations_by_url[res.annotation];

                            // aggiungo l'evento a workspace
                            var index = _.sortedIndexBy(workspace.punctuals, res, 'start');
                            workspace.punctuals.splice(index, 0, res);
                            //select_puntual_annotation_menu.annotations.push(res);

                            // aggingo l'evento al grafico
                            chart_manager.add_event(res);
                            chart_manager.refresh_properties();
                        }).error(function (data) {
                            console.log(data);
                        }).always(function () {
                            // chiudo la finestra
                            $('#show_punctual_annotations_modal').modal('toggle');
                        })
                    }
                }
            });

            select_interval_annotation_menu = new Vue({
                el: '#select_interval_annotation_menu',
                data: {
                    annotations: annotation_events.interval,
                    start: undefined,
                    end: undefined,
                    interval_event_url: '{% url "intervalannotationevent-list" %}'
                },
                methods: {
                    create_event: function (annotation_index) {
                        var annotation = this.annotations[annotation_index];

                        $.ajax(this.interval_event_url, {
                            'method': 'POST',
                            'data': {
                                'workspace': workspace.url,
                                'annotation': annotation.url,
                                'start': this.start,
                                'stop': this.end
                            }
                        }).done(function (data) {
                            // ottengo l'annotazione corrispondente
                            data.annotation = annotations_by_url[data.annotation];

                            // aggiungo l'evento a workspace
                            var index = _.sortedIndexBy(workspace.intervals, data, 'start');
                            workspace.intervals.splice(index, 0, data);

                            // aggingo l'evento al grafico
                            chart_manager.add_event(data);
                            chart_manager.refresh_properties();
                        }).error(function (data) {
                            console.log(data);
                        }).always(function () {
                            // chiudo la finestra
                            $('#show_interval_annotations_modal').modal('toggle');
                        })
                    }
                }
            });

            analysis_options_menu = new Vue({
                el: '#create_analysis_modal',
                data: {
                    name: '',
                    type: '',
                    analysis_types: ['fft', 'ewma'],
                    options: {
                        'fft': {
                            'n': '',
                            'norm': 'None'
                        },
                        'ewma': {
                            'com': '',
                            'span': '',
                            'halflif': '',
                            'min_periods': '',
                            'freq': '',
                            'adjust': '',
                            'how': ''
                        }
                    },
                    errors: {
                        'generic': [],
                        'name': [],
                        'type': [],
                        'options': {
                            'fft': {
                                'n': [],
                                'norm': [],
                                'non_field_errors': []
                            },
                            'ewma': {
                                'com': [],
                                'span': [],
                                'halflife': [],
                                'min_periods': [],
                                'freq': [],
                                'adjust': [],
                                'how': [],
                                'non_field_errors': []
                            }
                        }
                    }
                },
                computed: {
                    show_fft: function () {
                        return this.type === 'fft';
                    },
                    show_ewma: function () {
                        return this.type === 'ewma';
                    }
                },
                methods: {
                    __reset_errors: function (errors) {
                        for (var key in errors) {
                            if (errors.hasOwnProperty(key)) {
                                var ek = errors[key];
                                if (ek.constructor === Array) {
                                    errors[key] = [];
                                } else {
                                    this.__reset_errors(ek);
                                }
                            }
                        }
                    },
                    reset_errors: function () {
                        this.__reset_errors(this.errors);
                    },
                    check_errors: function () {
                        var data = {
                            'options': {}
                        };
                        var errors = false;
                        if (this.name === '') {
                            this.errors.name.push('Can not be blank');
                            errors = true;
                        } else {
                            data.name = this.name;
                        }

                        var t = this.type;
                        if (_.findIndex(this.analysis_types, function (o) {
                                return o === t;
                            }) !== -1) {
                            data.type = this.type;
                            var options = this.options[this.type];
                            var data_options = {};

                            for (var key in options) {
                                if (options.hasOwnProperty(key)) {
                                    var o = options[key];

                                    // caso particolare
                                    if ((this.type === 'fft') && (key === 'norm')) {
                                        if (o !== 'None') {
                                            data_options[key] = o;
                                        }
                                    } else {
                                        if (o !== '') {
                                            data_options[key] = o;
                                        }
                                    }
                                }
                            }

                            data.options[this.type] = data_options;
                        } else {
                            this.errors.type.push('Not a valid type');
                            errors = true;
                        }

                        if (errors)
                            return null;

                        return data;
                    },
                    create_analysis: function () {
                        this.reset_errors();
                        var request_data = this.check_errors();

                        var file = menu_files.files[menu_files.select_analysis_file_index];
                        var field = file.fields[menu_files.select_analysis_field_index];

                        if (request_data === null)
                            return;

                        $.ajax(field.analysis_url, {
                            method: 'POST',
                            data: JSON.stringify(request_data),
                            contentType: "application/json; charset=utf-8",
                            dataType: "json"
                        }).done(function (data) {
                            add_field_to_file(data, file);
                            var request_pk = requests_watcher.add_listener('files', function () {
                                chart_manager.add_field_of_file(data, file);
                                chart_manager.refresh();
                                requests_watcher.remove_listener('files', request_pk);
                            });

                            // chiudo la finestra d'analisi
                            $('#create_analysis_modal').modal('toggle');
                        }).fail(function (data) {
                            analysis_options_menu.reset_errors();

                            var response = data.responseJSON;
                            var errors = analysis_options_menu.errors;
                            var set_error_function = function (errors, where_to_set) {
                                for (var key in errors) {
                                    if (errors.hasOwnProperty(key)) {
                                        var ek = errors[key];
                                        if (ek.constructor === Array) {
                                            where_to_set[key] = where_to_set[key].concat(ek);
                                        } else {
                                            set_error_function(ek, where_to_set[key]);
                                        }
                                    }
                                }
                            };

                            set_error_function(response, analysis_options_menu.errors);
                        })
                    }
                }
            });

            // ASSEGNO IL CHART AL MANAGER
            chart_manager = new ChartManager(chart);
            chart_manager.set_points_per_field(points_per_field.n_points);


            // OTTENGO LE ANNOTAZIONI DISPONIBILI
            get_annotations(punctual_url, interval_url);

            // CREO GLI EVENTI DEL GRAFICO
            // aggiungo un listener all'evento change che memorizza l'ultima posizione del mouse
            this.chart.addListener('changed', function (e) {
                chart_manager.last_cursor_position = e.index;
            });

            // quando l'utente fa click apro il menù di selezione di un punctual annotation
            this.chart.addListener('clickGraph', function (e) {
                // memorizzo l'indice relativo al'ultima posizione del mouse
                select_puntual_annotation_menu.start = chart_manager.data[chart_manager.last_cursor_position].index;
                // apro la finestra di selezione dell'annotazione
                $('#show_punctual_annotations_modal').modal('toggle');
            });

            // quando l'utente seleziona un area
            this.chart.chartCursor.addListener('selected', function (e) {
                // memorizzo l'indice di inzio e fine
                select_interval_annotation_menu.start = chart_manager.data[e.start].index;
                select_interval_annotation_menu.end = chart_manager.data[e.end].index;

                // visualizza la selezione di un'annotazione di intervallo
                $('#show_interval_annotations_modal').modal('toggle');
            })
        };

        var v_files;
        var menu_files;
        var points_per_field;
        var menu_punctual_events;
        var menu_interval_events;
        var select_puntual_annotation_menu;
        var select_interval_annotation_menu;
        var analysis_options_menu;
        var chart_manager;
        var annotation_type;
        var punctual_ann_url;
        var interval_ann_url;

        $('#create_annotation_type_form').submit(function () {
            $("#create_annotation_type_form_errors").empty();
            punctual_ann_url = '{% url "punctualannotation-list" %}';
            interval_ann_url = '{% url "intervalannotation-list" %}';

            var ann_type = $("#select_ann_type").val();
            var url;
            if (ann_type == "Punctual")
                url = punctual_ann_url;
            else
                url = interval_ann_url;

            // creo "manualmente" il form contenente il nome e la descrizione della nuova categoria di annotazione
            var fd = new FormData();

            fd.append($("#ann_type_name").attr("name"), $("#ann_type_name").val());
            fd.append($("#ann_type_description").attr("name"), $("#ann_type_description").val());

            /*var it = fd.entries();
            var current = {};
            while ( ! current.done ) {
                current = it.next();
                console.info( current )
            }*/

            // invio la richiesta di caricamento del file al server
            $.ajax({
                url: url,
                data: fd,
                type: "POST",
                cache: false,
                processData: false,
                contentType: false,
                success: function (results) {
                    $("#create_annotation_type_modal").modal('toggle');
                    var ann = ann_type.charAt(0).toLowerCase() + ann_type.slice(1);
                    annotation_type.anns[ann].push(results);
                    annotations_by_url[results.url] = results;
                },
                error: function (errormessage) {
                    var errors = errormessage.responseJSON;
                    var error_message = "";
                    for (error_index in errors) {
                        var error_index_name = error_index.charAt(0).toUpperCase() + error_index.slice(1);
                        error_message += '<div class="alert alert-danger"><strong><p>';
                        error_message += error_index_name + ": ";
                        error_message += errors[error_index];
                        error_message += "</p></strong></div>";
                    }
                    $("#create_annotation_type_form_errors").html(error_message);

                }
            });
        });

        // funzione che viene eseguita alla sottomissione della form contenente il file da caricare sul server
        // l'upload del file viene eseguito via AJAX in modo da evitare di ricaricare tutte le volte tutta la pagina
        // (e con essa tutti i file) e in modo da conoscere quanto tempo ci impiega l'elaborazione lato server
        // durante questo periodo di attesa viene visualizzato all'utente uno spinner
        $('#create_file_form').submit(function () {
            var file_url_structure = '{% url 'file-detail' 'file_pk' %}';

            // creo "manualmente" il form contenente il file da caricare sul server
            var fd = new FormData();
            $("#create_file_form :input").each(function () {

                if (this.type != 'submit') {
                    var val;
                    var name = this.name;

                    if (this.type == 'file') {
                        val = this.files[0];
                    }
                    else {
                        val = this.value;
                    }
                    //data[name]=val;
                    fd.append(name, val);
                }
            });

            // visualizzo il modal contenente lo spinner
            $("#data_processing_modal").modal('toggle');

            // invio la richiesta di caricamento del file al server
            $.ajax({
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();

                    xhr.upload.addEventListener("progress", function (evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = evt.loaded / evt.total;
                            percentComplete = parseInt(percentComplete * 100);

                        }
                    }, false);

                    return xhr;
                },
                url: "{{ form_action }}",
                data: fd,
                type: "POST",
                cache: false,
                processData: false,
                contentType: false,
                success: function (result) {
                    var request_files_id = requests_watcher.add_listener('files', file_listener);
                    if ($('#loading_file_modal').is(':visible')) {
                        $("#loading_file_modal").modal('toggle');
                    }
                    var file_url = file_url_structure.replace("file_pk", result['results']['file_pk']);
                    get_file(file_url);
                    $("#data_processing_modal").modal('toggle');
                }
            });

            return false; // return false to cancel form action
        });

        // alla pressione del tasto upload file il modal viene nascosto
        $("#upload_file_button").click(function () {
            $("#create_file_modal").modal('toggle');
        });

        $("#export_confirm_button").click(function () {
            $("#export_file_modal").modal("hide");
        });
    </script>
{% endblock %}